let PhishingDomains =
externaldata(Domain:string)
[
  @"https://raw.githubusercontent.com/CyberArk0961/Phishing-Domains/refs/heads/main/output/daily_phishing_domains.csv"
]
with (format="csv", ignoreFirstRecord=true)
| summarize DomainSet = make_set(tolower(Domain), 5000);   // hard cap

DeviceNetworkEvents
| where Timestamp > ago(7d)
| where ActionType in ("ConnectionSuccess", "HttpConnectionInspected")
| where isnotempty(RemoteUrl)
| extend UrlDomain = tolower(tostring(parse_url(RemoteUrl).Host))
| where UrlDomain has_any (DomainSet)
| project
    Timestamp,
    DeviceName,
    RemoteUrl,
    UrlDomain,
    InitiatingProcessFileName,
    ActionType,
    ReportId
| sort by Timestamp desc
